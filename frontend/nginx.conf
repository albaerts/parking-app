server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # Cache static assets aggressively (filenames are content-hashed by build)
    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|webp|json)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri =404;
    }

    # Ensure service worker is not cached indefinitely (if present)
    location = /service-worker.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        expires -1;
        try_files $uri =404;
    }

    # Version marker should never be cached to reflect latest deploy
    location = /version.txt {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        expires -1;
        try_files $uri =404;
    }

    # Never cache index.html so new deployments are picked up immediately
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        expires -1;
        try_files $uri =404;
    }

    # SPA fallback: route all other requests to index.html
    location / {
        try_files $uri /index.html;
    }
}
upstream backend {
    server parking_backend:8000;
}

server {
    listen 80;
    server_name localhost;

    # Root of the built React app
    root /usr/share/nginx/html;
    index index.html;

    # Proxy API and auth endpoints to FastAPI backend
    location ~ ^/(login\.php|register\.php)$ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Email verification API (proxy any /verify-email/<token> to backend)
    location ^~ /verify-email/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Geo search proxy to backend (FastAPI /geo/search)
    location ^~ /geo/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /user/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /owner/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Handle assets normally
    location /static/ {
        try_files $uri =404;
    }

    # If app expects /parking prefix rewrite to root for static files
    location /parking/ {
        rewrite ^/parking/(.*)$ /$1 break;
        try_files $uri /index.html;
    }

    # Fallback for SPA routing
    location / {
        try_files $uri /index.html;
    }

    error_page 404 /index.html;

    add_header Cache-Control "no-cache";
}